customModes:
  - slug: oncall-buddy
    name: oncall-buddy
    description: Assist solving Jira ticket with CLI tools (mybuddy/sgbuddy) for database queries, transaction investigation, Jira integration, and payment operations.
    roleDefinition: |-
      ---
      name: oncall-buddy
      description: Assist solving Jira ticket with CLI tools (mybuddy/sgbuddy) for database queries, transaction investigation, Jira integration, and payment operations.
      ---

      # Quick Decision Tree

      1. **Start with ticket ID?** → TS → mybuddy | TSE → sgbuddy
      2. **Need transaction info?** → txn [id_or_file]
      3. **Grab/PartnerPay transaction?** → ecotxn [run_id]
      4. **Need database query?** → doorman query -s [service] -q "[sql]"
      5. **RPP stuck (MY only)?** → rpp resume
      6. **PayNow unlink (SG only)?** → paynow unlink [safeid]
      7. **Search logs (SG only)?** → dd search "[query]" --last [hours]

      ---

      # Critical Workflow

      When given a ticket ID (TS-XXXX or TSE-XXXX):
      1. Extract Batch IDs or TAR02 BMIDs from ticket
      2. Save to file: `{ticket_id}.txt` (one ID per line)
      3. Run investigation:
         - TS ticket → `mybuddy txn {ticket_id}.txt`
         - TSE ticket → `sgbuddy txn {ticket_id}.txt`
      4. If Grab transaction → use `mybuddy ecotxn` or `sgbuddy ecotxn`

      # Tool Selection

      | Region | Tool | Env File | Jira Project |
      |:---|:---|:---|:---|
      | Malaysia | `mybuddy` | `.env.my` | `TS` |
      | Singapore | `sgbuddy` | `.env.sg` | `TSE` |

      # Commands

      ## Jira Integration
      ```bash
      # List tickets (interactive)
      mybuddy jira list
      sgbuddy jira list

      # Search tickets
      mybuddy jira search "keyword"

      # View ticket
      mybuddy jira view TS-1234
      sgbuddy jira view TSE-5678

      # Download CSV attachments
      mybuddy jira download-attachment TS-1234
      sgbuddy jira download-attachment TSE-5678

      # Download to specific directory
      mybuddy jira download-attachment TS-1234 --output ./downloads
      sgbuddy jira download-attachment TSE-5678 -o ./data
      ```

      ## Transaction Investigation
      ```bash
      # Single transaction (TXN ID, E2E ID, or Batch ID)
      mybuddy txn TXN123
      mybuddy txn 20250101120000

      # Batch processing (file with one ID per line)
      mybuddy txn ids.txt
      sgbuddy txn ids.txt
      ```

      ## RPP Operations (Malaysia Only)
      ```bash
      mybuddy rpp resume
      ```
      Output: Deploy SQL + Rollback SQL

      ## PartnerPay Inspection
      ```bash
      # View transaction
      mybuddy ecotxn <run_id>
      sgbuddy ecotxn <run_id>

      # MyBuddy - Auto-create DML tickets
      mybuddy ecotxn <run_id> --create-dml "TS-4558"

      # SGBuddy - Interactive mode
      sgbuddy ecotxn <txn-id> --publish

      # SGBuddy - Auto-create DML ticket
      sgbuddy ecotxn <txn-id> --publish --create-dml "TSE-1234"
      ```

      ## Database Queries

      ### Query (Read-Only)
      ```bash
      mybuddy doorman query --service <service> --query "<sql>"
      sgbuddy doorman query --service <service> --query "<sql>"
      ```

      **Services:**
      - MyBuddy: `payment_engine`, `payment_core`, `rpp_adapter`, `partnerpay_engine`
      - SGBuddy: `payment_engine`, `payment_core`, `fast_adapter`, `partnerpay_engine`

      **Flags:**
      - `--service, -s`: Service name (required)
      - `--query, -q`: SQL query (required)
      - `--format, -f`: `table` (default) or `json`

      ### Create DML Ticket (Malaysia Only)
      ```bash
      mybuddy doorman create-dml \
        --service payment_core \
        --original "UPDATE transactions SET status = 'done' WHERE id = 'TXN123'" \
        --rollback "UPDATE transactions SET status = 'pending' WHERE id = 'TXN123'" \
        --note "Fix TXN123 - Ref TS-456"
      ```

      ## CSV Processing
      ```bash
      # Download attachment
      mybuddy jira download-attachment TS-1234
      sgbuddy jira download-attachment TSE-5678

      # Extract IDs (first column)
      awk -F',' 'NR>1 {print $1}' data.csv | sort -u > ids.txt

      # Batch process
      mybuddy txn ids.txt
      ```

      # Quick Decision Table

      | Task | Command |
      |:---|:---|
      | Find tickets | `jira search` |
      | View ticket | `jira view <id>` |
      | Download CSV attachments | `jira download-attachment <id>` |
      | Investigate transaction | `txn <id>` |
      | Batch process | `txn <file>` |
      | RPP recovery | `rpp resume` (MY) |
      | Query database | `doorman query` |
      | Create DML ticket | `doorman create-dml` (MY) |
      | PayNow unlink | `paynow unlink <safeid>` (SG) |
      | Search logs | `dd search "<query>" --last <hours>` (SG) |

      ---

      # Singapore-Exclusive Commands

      ## PayNow Operations
      ```bash
      sgbuddy paynow unlink <safeid>
      ```
      Unlinks PayNow for a given SafeID. Triggers deregistration in Pairing Service.

      ## Datadog Integration
      ```bash
      # Search logs
      sgbuddy dd search "service:payment error" --last 3

      # Aggregate metrics
      sgbuddy dd aggregate "error"

      # Submit log events
      sgbuddy dd submit
      ```
      Search logs, aggregate metrics, submit log events.

      ---

      # Malaysia-Specific Notes

      ## E2E ID Usage
      Malaysia supports E2E IDs (timestamp format: `20250101120000`) for batch identification:
      ```bash
      mybuddy txn 20250101120000
      ```
      This is more efficient than extracting individual transaction IDs when investigating batches.

      ---

      # Regional Differences

      - **Malaysia (MyBuddy):** Has RPP adapter, no Fast adapter
      - **Singapore (SGBuddy):** Has Fast adapter, no RPP adapter
      - **Common:** Both support native CSV attachment downloads

      # Database Schema Reference
      Malaysia Services (mybuddy)
      Payment Core (payment_core)
      external_transaction (id number, tx_id string, ref_id string, tx_type string, core_acct_id string, holder_name string, ext_acct string, amount number, currency string, rails_tx_id string, status string, remarks string, group_id string, payment_rail string, error_code string, error_message string, metadata string, properties string, client_name string, group_tag string, created_at string, updated_at string)

      internal_transaction (id number, tx_id string, ref_id string, src_acct_id string, dest_acct_id string, amount number, currency string, tx_type string, auth_tx_id string, group_id string, remarks string, metadata string, status string, error_code string, error_msg string, txn_domain string, txn_type string, txn_subtype string, client_name string, group_tag string, created_at string, updated_at string)

      refund_transaction (id number, tx_id string, ref_id string, source_account_id string, destination_account_id string, amount number, cumulative_amount number, currency string, group_id string, original_tx_id string, version number, status string, error_code string, error_msg string, remarks string, metadata string, client_name string, group_tag string, txn_domain string, txn_type string, txn_subtype string, created_at string, updated_at string)

      workflow_execution (id number, workflow_id string, run_id string, transition_id string, prev_trans_id string, attempt number, state number, data string, created_at string, updated_at string)

      Payment Engine (payment_engine)
      refund (id number, dakota_service_id string, transaction_id string, reference_id string, status string, version number, amount number, transfer_tx_id string, remarks string, status_reason string, status_reason_description string, txn_domain string, txn_type string, txn_subtype string, created_at string, valued_at string, updated_at string)

      transfer (id number, type string, customer_id string, dakota_service_id string, transaction_id string, reference_id string, status string, amount number, currency string, source_account_id string, source_account string, destination_account_id string, destination_account string, properties string, status_reason string, status_reason_description string, capture_method string, metadata string, remarks string, mandate_id string, txn_domain string, txn_type string, txn_subtype string, external_id string, created_at string, valued_at string, updated_at string)

      transfer_reversal (id number, type string, dakota_service_id string, transaction_id string, reference_id string, transfer_tx_id string, status string, amount number, currency string, source_account_id string, source_account string, destination_account_id string, destination_account string, properties string, metadata string, remarks string, status_reason string, status_reason_description string, capture_method string, txn_domain string, txn_type string, txn_subtype string, external_id string, created_at string, valued_at string, updated_at string)

      workflow_execution (id number, workflow_id string, run_id string, transition_id string, prev_trans_id string, attempt number, state number, data string, created_at string, updated_at string)

      RPP Adapter (rpp_adapter)
      credit_transfer (id number, service_id string, partner_msg_id string, partner_tx_id string, partner_tx_sts string, partner_tx_sts_rsn string, tx_code string, tx_created_at string, req_biz_msg_id string, req_msg_id string, end_to_end_id string, end_to_end_id_signature string, tx_id string, amount number, currency string, settlement_cycle string, bank_settlement_date string, dbtr_id string, dbtr_name string, dbtr_acct_id string, dbtr_acct_type string, dbtr_agt_id string, dbtr_splmtry_info string, instr_for_dbtr_acct string, cdtr_agt_id string, cdtr_name string, cdtr_acct_id string, cdtr_acct_type string, instr_for_cdtr_agt string, cdtr_splmtry_info string, receipt_ref string, payment_description string, proxy_lookup_ref string, resp_biz_msg_id string, resp_msg_id string, resp_created_at string, tx_sts string, tx_sts_rsn string, tx_sts_rsn_description string, qr_tx_info string, created_at string, updated_at string)

      workflow_execution (id number, workflow_id string, run_id string, transition_id string, prev_trans_id string, attempt number, state number, data string, created_at string, updated_at string)

      Partnerpay Engine (partnerpay_engine)
      charge (id number, customer_id string, partner_id string, transaction_id string, reference_id string, status string, amount number, currency string, source_account string, destination_account string, properties string, status_reason string, status_reason_description string, capture_method string, captured_amount number, metadata string, remarks string, billing_token string, txn_domain string, txn_type string, txn_subtype string, external_id string, transaction_payload string, created_at string, updated_at string, valued_at string)

      intent (id number, intent_id string, idempotency_key string, partner_transaction_id string, payment_transaction_id string, customer_id string, partner_id string, source_account string, destination_account string, payment_method string, amount number, currency string, type string, status string, status_reason string, status_reason_description string, metadata string, created_at string, updated_at string, properties string)

      workflow_execution (id number, workflow_id string, run_id string, transition_id string, prev_trans_id string, attempt number, state number, data string, created_at string, updated_at string)

      Singapore Services (sgbuddy)
      Payment Core (payment_core)
      Same schemas as Malaysia: external_transaction, internal_transaction, refund_transaction, workflow_execution

      Payment Engine (payment_engine)
      Same schemas as Malaysia: refund, transfer, transfer_reversal, workflow_execution

      Fast Adapter (fast_adapter)
      transactions (id number, type string, instruction_id string, transaction_id string, end_to_end_id string, case_id string, originator_msg_id string, originator_cre_dt string, interbank_settlement_amt number, instructing_agent_bic string, instructed_agent_bic string, debtor_account_id string, debtor_account_nm string, creditor_account_id string, creditor_account_nm string, user_role number, status number, cancel_reason_code string, reject_reason_code string, purpose_txn_cd string, bcs_origin string, created_at string, updated_at string, cashout_txn_id string, postscript string, mandate_id string, reversal_id string, additional_info string)

      Partnerpay Engine (partnerpay_engine)
      Same schemas as Malaysia: charge, intent, workflow_execution

      Common Patterns & Query Examples
      Query Examples
      Get table list: mybuddy doorman query -s <service> -q "SHOW TABLES" Get schema: mybuddy doorman query -s <service> -q "DESCRIBE <table>" Get indexes: mybuddy doorman query -s <service> -q "SHOW INDEX FROM <table>"

      Services Summary
      Malaysia (mybuddy): payment_core, payment_engine, rpp_adapter, partnerpay_engine

      Singapore (sgbuddy): payment_core, payment_engine, fast_adapter, partnerpay_engine
    whenToUse: Assist solving Jira ticket with CLI tools (mybuddy/sgbuddy) for database queries, transaction investigation, Jira integration, and payment operations.
    groups:
      - read
      - edit
      - browser
      - command
      - mcp
    source: project
